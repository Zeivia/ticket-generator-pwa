<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de Tiquet</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 700px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; margin-bottom: 20px; }
    label { font-weight: bold; display:block; margin-top:8px; }
    input, textarea { width: 100%; padding: 8px; margin: 6px 0 14px 0; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }

    #lineas, #clienteCampos { margin-bottom: 12px; }

    .linea, .clienteLinea { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
    .concepto { flex: 1; padding: 6px; }
    .precio { width: 120px; padding: 6px; text-align: right; }
    .remove { background: transparent; border: none; cursor: pointer; font-size: 18px; }

    .controls { display:flex; gap:10px; margin-bottom: 10px; }
    .controls button { flex:1; padding: 10px; border: none; border-radius: 8px; background: #0077cc; color: white; font-size: 16px; cursor: pointer; }

    #addLine { background: #28a745; }
    #clearLines { background: #dc3545; }
    #addClienteCampo { background: #17a2b8; }
    #clearClienteCampos { background: #ffc107; color: black; }
    #generar { background: #0077cc; }
    #preview { background: #6c757d; }

    #downloadImage { background: #17a2b8; color: white; padding: 10px; border:none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; display:none; }

    #ticket {
      display: none;
      padding: 20px;
      font-family: "Courier New", monospace;
      background: white;
      border: 1px dashed #333;
      width: 320px;
      margin: auto;
      white-space: normal;
    }

    #ticket h3 { text-align: center; margin: 0 0 8px 0; }

    #ticket .line { display:flex; justify-content:space-between; gap:8px; align-items:flex-start; }
    #ticket .left {
      flex:1;
      border-bottom:1px dotted #999;
      padding-right: 8px;
      white-space: normal;
      word-wrap: break-word;
    }
    #ticket .right {
      min-width:70px;
      text-align:right;
      white-space: nowrap;
    }

    #ticket .clienteTitulo {
      font-weight: bold;
      margin-top: 12px;
      margin-bottom: 4px;
    }

    #ticket .clienteLinea {
      font-size: 12px;
      line-height: 1.1;
      margin-left: 10px;
      margin-top: 2px;
      margin-bottom: 2px;
      white-space: normal;
    }

    @media print {
      body * { visibility: hidden; }
      #ticket, #ticket * { visibility: visible; }
      #ticket { position: absolute; top: 20px; left: 0; right: 0; margin: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Generador de Tiquet</h2>

    <label>Empresa que genera el tiquet</label>
    <input type="text" id="empresa" placeholder="Ej: McDonald's" />

    <label>Fecha de la compra</label>
    <input type="date" id="fecha" />

    <label>Logo (opcional)</label>
    <input type="file" id="logo" accept="image/*" />

    <label>Documento (opcional)</label>
    <input type="text" id="numDoc" placeholder="Ej: Num tiquet, factura, documento..." />

    <h3>Conceptos</h3>
    <div id="lineas"></div>

    <div class="controls">
      <button id="addLine">Añadir línea</button>
      <button id="clearLines">Borrar líneas</button>
    </div>

    <h3>Cliente (opcional)</h3>
    <div id="clienteCampos"></div>

    <div class="controls">
      <button id="addClienteCampo">Añadir campo cliente</button>
      <button id="clearClienteCampos">Borrar campos cliente</button>
    </div>

    <label>Observaciones</label>
    <textarea id="obs" rows="3"></textarea>

    <div style="margin-top:12px; display:flex; gap:10px;">
      <button id="generar">Generar Ticket</button>
      <button id="preview">Vista previa</button>
    </div>

    <button id="downloadImage">Descargar como imagen</button>
  </div>

  <div id="ticket"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const lineasCont = document.getElementById('lineas');
      const clienteCont = document.getElementById('clienteCampos');
      const fechaInput = document.getElementById('fecha');
      const downloadBtn = document.getElementById('downloadImage');

      fechaInput.value = new Date().toISOString().slice(0,10);

      let logoDataURL = null;
      document.getElementById('logo').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return logoDataURL = null;
        const r = new FileReader();
        r.onload = ev => logoDataURL = ev.target.result;
        r.readAsDataURL(file);
      });

      function escapeHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      }

      function agregarLinea(concepto = '', precio = '') {
        const div = document.createElement('div');
        div.className = 'linea';
        div.innerHTML = `
          <input type="text" class="concepto" placeholder="Concepto" value="${escapeHtml(concepto)}" />
          <input type="number" class="precio" step="0.01" placeholder="€" value="${precio}" />
          <button class="remove">✖</button>
        `;
        div.querySelector('.remove').onclick = () => div.remove();
        lineasCont.appendChild(div);
      }

      function agregarClienteCampo(valor = '') {
        const div = document.createElement('div');
        div.className = 'clienteLinea';
        div.innerHTML = `
          <input type="text" class="concepto" placeholder="Campo cliente" value="${escapeHtml(valor)}" />
          <button class="remove">✖</button>
        `;
        div.querySelector('.remove').onclick = () => div.remove();
        clienteCont.appendChild(div);
      }

      function generarHtmlTicket(preview = false) {
        const empresa = document.getElementById('empresa').value || '---';
        const fecha = fechaInput.value || '';
        const obs = document.getElementById('obs').value || '';
        const numDoc = document.getElementById('numDoc').value || '';

        const conceptos = [...document.querySelectorAll('#lineas .concepto')];
        const precios = [...document.querySelectorAll('#lineas .precio')];
        const clienteCamposInputs = [...document.querySelectorAll('#clienteCampos .concepto')];

        let html = '';

        if (logoDataURL) {
          html += `<div style="text-align:center; margin-bottom:10px;"><img src="${logoDataURL}" style="max-width:150px; max-height:80px; object-fit:contain;" /></div>`;
        }

        html += `<h3>${escapeHtml(empresa)}</h3>`;

        if (numDoc.trim() !== '') html += `<p><strong>Documento:</strong> ${escapeHtml(numDoc)}</p>`;

        if (fecha) {
          const d = new Date(fecha);
          const fechaFormat = ('0'+d.getDate()).slice(-2)+'/'+('0'+(d.getMonth()+1)).slice(-2)+'/'+d.getFullYear();
          html += `<p><strong>Fecha:</strong> ${escapeHtml(fechaFormat)}</p>`;
        } else html += `<p><strong>Fecha:</strong> ---</p>`;

        const clienteDatos = clienteCamposInputs.map(i => i.value.trim()).filter(t => t !== '');
        if (clienteDatos.length > 0) {
          html += `<p class="clienteTitulo">Cliente:</p>`;
          clienteDatos.forEach(linea => html += `<p class="clienteLinea">${escapeHtml(linea)}</p>`);
        }

        html += `<hr>`;

        let total = 0;
        for (let i = 0; i < conceptos.length; i++) {
          const c = conceptos[i].value || '';
          const p = parseFloat(precios[i].value) || 0;
          if (c.trim() !== '' || p > 0) {
            html += `<div class="line"><div class="left">${escapeHtml(c)}</div><div class="right">${p.toFixed(2)}€</div></div>`;
            total += p;
          }
        }

        html += `<hr><p><strong>Total: ${total.toFixed(2)}€</strong></p>`;

        if (obs.trim() !== '') html += `<hr><p>Obs: ${escapeHtml(obs)}</p>`;

        if (preview) {
          const ticketDiv = document.getElementById('ticket');
          ticketDiv.innerHTML = html;
          ticketDiv.style.display = 'block';
          downloadBtn.style.display = 'inline-block';
        }

        return html;
      }

      document.getElementById('addLine').onclick = () => agregarLinea();
      document.getElementById('clearLines').onclick = () => lineasCont.innerHTML = '';
      document.getElementById('addClienteCampo').onclick = () => agregarClienteCampo();
      document.getElementById('clearClienteCampos').onclick = () => clienteCont.innerHTML='';

      document.getElementById('generar').onclick = () => { generarHtmlTicket(true); window.print(); };
      document.getElementById('preview').onclick = () => generarHtmlTicket(true);

      downloadBtn.onclick = async () => {
        const ticket = document.getElementById('ticket');
        if (!ticket.style.display || ticket.style.display === 'none') return alert('Primero genera una vista previa');
        const canvas = await html2canvas(ticket);
        const link = document.createElement('a');
        link.download = 'ticket.png';
        link.href = canvas.toDataURL();
        link.click();
      };

      agregarLinea();
      agregarClienteCampo();

      if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');
    });
  </script>
</body>
</html>
