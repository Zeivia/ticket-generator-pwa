<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de Tiquet</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 700px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; margin-bottom: 20px; }
    label { font-weight: bold; display:block; margin-top:8px; }
    input, textarea { width: 100%; padding: 8px; margin: 6px 0 14px 0; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
    #lineas { margin-bottom: 12px; }
    .linea { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
    .linea .concepto { flex: 1; padding: 6px; }
    .linea .precio { width: 120px; padding: 6px; text-align: right; }
    .linea .remove { background: transparent; border: none; cursor: pointer; font-size: 18px; }
    .controls { display:flex; gap:10px; margin-bottom: 10px; }
    .controls button { flex:1; padding: 10px; border: none; border-radius: 8px; background: #0077cc; color: white; font-size: 16px; cursor: pointer; }
    .controls button:hover { filter:brightness(.95); }
    #addLine { background: #28a745; }
    #addLine:hover { filter:brightness(.95); }
    #clearLines { background: #dc3545; }
    #clearLines:hover { filter:brightness(.95); }
    #generar { background: #0077cc; }
    #generar:hover { filter:brightness(.95); }
    #preview { background: #6c757d; }
    #preview:hover { filter:brightness(.95); }
    #downloadImage { background: #17a2b8; color: white; padding: 10px; border:none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; }
    #ticket {
      display: none;
      padding: 20px;
      font-family: "Courier New", monospace;
      background: white;
      border: 1px dashed #333;
      width: 320px;
      margin: auto;
      white-space: nowrap;
    }
    #ticket h3 { text-align: center; margin: 0 0 8px 0; }
    #ticket .line { display:flex; justify-content:space-between; gap:8px; }
    #ticket .left { flex:1; border-bottom:1px dotted #999; padding-right:8px; }
    #ticket .right { min-width:70px; text-align:right; }
    #ticket p { margin:6px 0; }
    @media print {
      body * { visibility: hidden; }
      #ticket, #ticket * { visibility: visible; }
      #ticket { position: absolute; top: 20px; left: 0; right: 0; margin: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Generador de Tiquet</h2>

    <label for="empresa">Empresa que genera el tiquet</label>
    <input type="text" id="empresa" placeholder="Ej: McDonald's" />

    <label for="fecha">Fecha de la compra</label>
    <input type="date" id="fecha" />

    <label for="logo">Logo (opcional)</label>
    <input type="file" id="logo" accept="image/*" />

    <label for="numDoc">Documento (opcional)</label>
    <input type="text" id="numDoc" placeholder="Ej: CIF, NIF, etc." />

    <h3>Conceptos</h3>
    <div id="lineas" aria-live="polite"></div>

    <div class="controls">
      <button id="addLine">Añadir línea</button>
      <button id="clearLines">Borrar líneas</button>
    </div>

    <label for="obs">Observaciones</label>
    <textarea id="obs" rows="3" placeholder="(Opcional)"></textarea>

    <div style="margin-top:12px; display:flex; gap:10px;">
      <button id="generar">Generar Ticket</button>
      <button id="preview">Vista previa</button>
    </div>

    <button id="downloadImage" style="display:none;">Descargar como imagen</button>
  </div>

  <div id="ticket" role="document" aria-label="Tiquet imprimible"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const lineasCont = document.getElementById('lineas');
      const addBtn = document.getElementById('addLine');
      const clearBtn = document.getElementById('clearLines');
      const generarBtn = document.getElementById('generar');
      const previewBtn = document.getElementById('preview');
      const downloadBtn = document.getElementById('downloadImage');
      const fechaInput = document.getElementById('fecha');

      // Fecha por defecto hoy
      const hoy = new Date().toISOString().slice(0,10);
      fechaInput.value = hoy;

      function escapeHtml(s) {
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }

      let logoDataURL = null; // Aquí guardaremos la imagen subida

      const logoInput = document.getElementById('logo');
      logoInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) {
          logoDataURL = null;
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          logoDataURL = e.target.result; // imagen en base64
        }
        reader.readAsDataURL(file);
      });

      function agregarLinea(concepto = '', precio = '') {
        const div = document.createElement('div');
        div.className = 'linea';
        div.innerHTML = `
          <input type="text" class="concepto" placeholder="Concepto" value="${escapeHtml(concepto)}" />
          <input type="number" class="precio" step="0.01" placeholder="€" value="${precio}" />
          <button class="remove" title="Eliminar línea">✖</button>
        `;
        div.querySelector('.remove').addEventListener('click', () => {
          lineasCont.removeChild(div);
        });
        lineasCont.appendChild(div);
        return div;
      }

      function generarHtmlTicket(preview = false) {
        const empresa = document.getElementById('empresa').value || '---';
        const fecha = fechaInput.value || '';
        const obs = document.getElementById('obs').value || '';
        const numDoc = document.getElementById('numDoc').value || '';

        const conceptos = [...document.querySelectorAll('.concepto')];
        const precios = [...document.querySelectorAll('.precio')];

        let html = '';

        if (logoDataURL) {
          html += `<div style="text-align:center; margin-bottom:10px;">
            <img src="${logoDataURL}" alt="Logo" style="max-width:150px; max-height:80px; object-fit: contain;" />
          </div>`;
        }

        html += `<h3>${escapeHtml(empresa)}</h3>`;

        if (numDoc.trim() !== '') {
          html += `<p><strong>Documento:</strong> ${escapeHtml(numDoc)}</p>`;
        }

        html += `<p>Fecha: ${escapeHtml(fecha)}</p>`;
        html += `<hr>`;

        let total = 0;

        for (let i = 0; i < conceptos.length; i++) {
          const c = conceptos[i].value || '';
          const p = parseFloat(precios[i].value) || 0;

          if (c.trim() !== '' || p > 0) {
            html += `<div class="line"><div class="left">${escapeHtml(c)}</div><div class="right">${p.toFixed(2)}€</div></div>`;
            total += p;
          }
        }

        html += `<hr>`;
        html += `<p><strong>Total: ${total.toFixed(2)}€</strong></p>`;

        if (obs.trim() !== '') {
          html += `<hr><p>Obs: ${escapeHtml(obs)}</p>`;
        }

        if (preview) {
          const ticketDiv = document.getElementById('ticket');
          ticketDiv.innerHTML = html;
          ticketDiv.style.display = 'block';
          downloadBtn.style.display = 'inline-block';
        }

        return html;
      }

      addBtn.addEventListener('click', () => agregarLinea());
      clearBtn.addEventListener('click', () => { lineasCont.innerHTML = ''; });
      generarBtn.addEventListener('click', () => {
        generarHtmlTicket(true);
        window.print();
      });
      previewBtn.addEventListener('click', () => {
        generarHtmlTicket(true);
      });

      downloadBtn.addEventListener('click', async () => {
        const ticket = document.getElementById('ticket');
        if (!ticket || ticket.style.display === 'none') {
          alert('Primero genera una vista previa del ticket.');
          return;
        }
        const canvas = await html2canvas(ticket);
        const link = document.createElement('a');
        link.download = 'ticket.png';
        link.href = canvas.toDataURL();
        link.click();
      });

      // Línea inicial
      agregarLinea();

      // Enter añade línea si estás en última línea precio
      lineasCont.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const isLast = e.target === lineasCont.lastElementChild?.querySelector('.precio') || false;
          if (isLast) {
            e.preventDefault();
            agregarLinea();
            const lastConcept = lineasCont.lastElementChild.querySelector('.concepto');
            if (lastConcept) lastConcept.focus();
          }
        }
      });

      // Registrar service worker para PWA
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js");
      }
    });
  </script>
</body>
</html>
